<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <!-- METADADOS PWA -->
    <meta name="theme-color" content="#0b63d4" />
    <meta
      name="description"
      content="Sistema de Fechamento de Caixa para Postos de Combustível"
    />
    <link
      rel="manifest"
      href="data:application/manifest+json,%7B%22name%22%3A%22Fechamento%20de%20Caixa%22%2C%22short_name%22%3A%22FechamentoCaixa%22%2C%22description%22%3A%22Sistema%20de%20fechamento%20de%20caixa%20para%20postos%20de%20combust%C3%ADvel%22%2C%22start_url%22%3A%22%2F%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%23f6fbff%22%2C%22theme_color%22%3A%22%230b63d4%22%2C%22orientation%22%3A%22portrait%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22data%3Aimage%2Fsvg%2Bxml%2C%3Csvg%20xmlns%3D'http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg'%20viewBox%3D'0%200%20100%20100'%3E%3Crect%20width%3D'100'%20height%3D'100'%20fill%3D'%230b63d4'%20rx%3D'20'%2F%3E%3Ctext%20x%3D'50'%20y%3D'70'%20font-family%3D'Arial'%20font-size%3D'60'%20text-anchor%3D'middle'%20fill%3D'white'%3E%F0%9F%92%B0%3C%2Ftext%3E%3C%2Fsvg%3E%22%2C%22sizes%22%3A%22192x192%22%2C%22type%22%3A%22image%2Fsvg%2Bxml%22%7D%2C%7B%22src%22%3A%22data%3Aimage%2Fsvg%2Bxml%2C%3Csvg%20xmlns%3D'http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg'%20viewBox%3D'0%200%20100%20100'%3E%3Crect%20width%3D'100'%20height%3D'100'%20fill%3D'%230b63d4'%20rx%3D'20'%2F%3E%3Ctext%20x%3D'50'%20y%3D'70'%20font-family%3D'Arial'%20font-size%3D'60'%20text-anchor%3D'middle'%20fill%3D'white'%3E%F0%9F%92%B0%3C%2Ftext%3E%3C%2Fsvg%3E%22%2C%22sizes%22%3A%22512x512%22%2C%22type%22%3A%22image%2Fsvg%2Bxml%22%7D%5D%7D"
    />

    <!-- ICONES PWA -->
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>💰</text></svg>"
    />
    <link
      rel="apple-touch-icon"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>💰</text></svg>"
    />

    <title>Fechamento de Caixa</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
      }

      body {
        font-family: "Poppins", sans-serif;
        background: #f6fbff;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        min-height: 100vh;
        color: #222;
        padding: 20px 0;
        overflow-y: auto;
        /* Prevenir zoom em iOS */
        touch-action: manipulation;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        user-select: none;
      }

      .card {
        background: #fff;
        border-radius: 12px;
        padding: 24px;
        width: 95%;
        max-width: 650px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        box-sizing: border-box;
        margin: auto;
        min-height: auto;
      }

      h1 {
        color: #0b63d4;
        font-size: 22px;
        text-align: center;
        margin-bottom: 20px;
        font-weight: 600;
      }

      label {
        display: block;
        margin-bottom: 8px;
        color: #333;
        font-weight: 500;
        font-size: 14px;
      }

      input {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #ddd;
        font-size: 14px;
        box-sizing: border-box;
        transition: border-color 0.2s;
        /* Melhorar experiência em mobile */
        -webkit-appearance: none;
        appearance: none;
      }

      input:focus {
        outline: none;
        border-color: #0b63d4;
      }

      button {
        padding: 10px 12px;
        border: none;
        border-radius: 8px;
        color: #fff;
        cursor: pointer;
        font-size: 13px;
        transition: 0.2s;
        font-weight: 500;
        /* Melhorar toque em mobile */
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
      }

      button:hover {
        opacity: 0.9;
        transform: translateY(-1px);
      }

      .add {
        background: #28a745;
        width: 100%;
      }

      .row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        margin-top: 8px;
      }

      .btns {
        display: flex;
        justify-content: space-between;
        margin-top: 8px;
        gap: 8px;
      }

      .totais {
        background: #eef6ff;
        padding: 16px;
        border-radius: 10px;
        margin-top: 20px;
        border: 1px solid #d0e3ff;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      td {
        padding: 10px 8px;
        font-size: 14px;
      }

      td:first-child {
        text-align: left;
        color: #555;
        font-weight: 500;
      }

      td:last-child {
        text-align: right;
        font-weight: 600;
        color: #222;
      }

      .cabecalho-total {
        background: #0b63d4 !important;
        color: white !important;
        font-size: 15px !important;
        padding: 12px 8px !important;
        width: 100%;
        margin-top: 16px;
        border-radius: 8px;
        font-weight: 600;
      }

      #baixarPDF,
      #fecharTurno {
        background: #0b63d4;
        width: 100%;
        margin-top: 16px;
        padding: 12px;
        font-size: 14px;
        border-radius: 8px;
        font-weight: 600;
      }

      #fecharTurno {
        background: #2c3e50;
        margin-top: 12px;
      }

      /* BOTÃO INSTALAR PWA */
      #installButton {
        background: #ff6b00;
        width: 100%;
        margin-top: 8px;
        padding: 12px;
        font-size: 14px;
        border-radius: 8px;
        font-weight: 600;
        display: none; /* Inicialmente escondido */
      }

      .erro {
        display: none;
        color: #d32f2f;
        font-size: 12px;
        margin-top: 4px;
      }

      /* ESTILO ATUALIZADO PARA O HISTÓRICO */
      .historico {
        margin-top: 24px;
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        padding: 16px;
        background: #fafafa;
        margin-bottom: 20px; /* ESPAÇO EXTRA NO FINAL */
      }

      .historico h3 {
        font-size: 16px;
        color: #333;
        margin-bottom: 12px;
        text-align: center;
        font-weight: 600;
      }

      .lista-historico {
        max-height: 300px; /* Altura aumentada */
        overflow-y: auto;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        background: white;
        padding: 0 12px;
      }

      .item-historico {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 8px;
        border-bottom: 1px solid #eee;
        font-size: 13px;
        min-height: 44px; /* Altura mínima para toque */
      }

      .item-historico:last-child {
        border-bottom: none;
      }

      .info-historico {
        flex: 1;
        display: flex;
        flex-direction: column;
      }

      .tipo-historico {
        font-weight: 600;
        color: #0b63d4;
      }

      .valor-historico {
        font-weight: 600;
        color: #28a745;
      }

      .subtracao .valor-historico {
        color: #dc3545;
      }

      .detalhes-historico {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
      }

      .hora-historico {
        color: #666;
        font-size: 11px;
      }

      .btn-remover {
        background: #dc3545;
        padding: 6px 10px;
        font-size: 11px;
        border-radius: 6px;
        margin-left: 12px;
        font-weight: 500;
        white-space: nowrap;
        flex-shrink: 0; /* Impede que o botão encolha */
      }

      .sem-historico {
        text-align: center;
        color: #999;
        font-style: italic;
        padding: 24px;
        font-size: 13px;
      }

      /* SCROLLBAR PERSONALIZADA */
      .lista-historico::-webkit-scrollbar {
        width: 6px;
      }

      .lista-historico::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
      }

      .lista-historico::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
      }

      .lista-historico::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
      }

      @media (max-width: 480px) {
        body {
          padding: 10px 0;
          align-items: flex-start;
          height: 100vh;
          overflow: hidden;
        }

        .card {
          padding: 16px;
          max-height: calc(100vh - 40px); /* Altura máxima com margem */
          overflow-y: auto;
          margin-bottom: 20px; /* Espaço extra no mobile */
        }

        h1 {
          font-size: 20px;
          margin-bottom: 16px;
        }

        .row {
          gap: 12px;
        }

        input {
          padding: 8px;
          font-size: 13px;
        }

        .btns button {
          font-size: 12px;
          padding: 8px;
        }

        .totais {
          padding: 12px;
          margin-top: 16px;
        }

        td {
          padding: 8px 6px;
          font-size: 13px;
        }

        .cabecalho-total {
          padding: 10px 6px !important;
          font-size: 14px !important;
        }

        .historico {
          padding: 12px;
          margin-top: 20px;
          margin-bottom: 30px; /* MAIS ESPAÇO NO MOBILE */
        }

        .lista-historico {
          max-height: 250px; /* Altura ajustada para mobile */
          padding: 0 8px;
        }

        .item-historico {
          font-size: 12px;
          padding: 10px 6px;
          min-height: 40px;
        }

        .detalhes-historico {
          gap: 6px;
        }

        .hora-historico {
          font-size: 10px;
        }

        .btn-remover {
          padding: 5px 8px;
          font-size: 10px;
          margin-left: 8px;
        }

        #baixarPDF,
        #fecharTurno,
        #installButton {
          padding: 10px;
          font-size: 13px;
          margin-top: 12px;
        }
      }

      /* Melhorias para telas muito pequenas */
      @media (max-width: 360px) {
        .card {
          padding: 12px;
        }

        .row {
          grid-template-columns: 1fr;
          gap: 10px;
        }

        .item-historico {
          flex-direction: column;
          align-items: flex-start;
          gap: 6px;
          padding: 8px 4px;
        }

        .btn-remover {
          align-self: flex-end;
          margin-left: 0;
          width: auto;
        }

        .detalhes-historico {
          width: 100%;
          justify-content: space-between;
        }
      }

      /* Ajustes para quando o teclado virtual aparece */
      @media (max-height: 500px) {
        body {
          align-items: flex-start;
        }

        .card {
          max-height: calc(100vh - 20px);
        }

        .lista-historico {
          max-height: 150px;
        }
      }

      /* Loading para PWA */
      .loading {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        z-index: 1000;
        justify-content: center;
        align-items: center;
        flex-direction: column;
      }

      .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #0b63d4;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js"></script>
  </head>

  <body>
    <!-- Loading para instalação -->
    <div class="loading" id="loading">
      <div class="loading-spinner"></div>
      <p style="margin-top: 20px; color: #0b63d4; font-weight: 600">
        Instalando App...
      </p>
    </div>

    <div class="card">
      <h1>Fechamento de Caixa</h1>

      <div class="row">
        <div>
          <label>Dinheiro (R$)</label>
          <input id="dinheiro" type="number" step="0.01" placeholder="0.00" />
          <div class="btns">
            <button class="add" onclick="adicionarValor('dinheiro')">
              Adicionar Valor
            </button>
          </div>
        </div>
        <div>
          <label>Cartão (R$)</label>
          <input id="cartao" type="number" step="0.01" placeholder="0.00" />
          <div class="btns">
            <button class="add" onclick="adicionarValor('cartao')">
              Adicionar Valor
            </button>
          </div>
        </div>
        <div>
          <label>Vale (R$)</label>
          <input id="vale" type="number" step="0.01" placeholder="0.00" />
          <div class="btns">
            <button class="add" onclick="adicionarValor('vale')">
              Adicionar Valor
            </button>
          </div>
        </div>
        <div>
          <label>Pix (R$)</label>
          <input id="pix" type="number" step="0.01" placeholder="0.00" />
          <div class="btns">
            <button class="add" onclick="adicionarValor('pix')">
              Adicionar Valor
            </button>
          </div>
        </div>
      </div>

      <div class="totais" id="resumo"></div>

      <button id="baixarPDF">Baixar PDF</button>
      <button id="fecharTurno">Fechar Turno (Zerar)</button>

      <!-- BOTÃO PARA INSTALAR O APP -->
      <button id="installButton">📲 Instalar App no Celular</button>

      <!-- HISTÓRICO -->
      <div class="historico">
        <h3>Últimos Valores Adicionados</h3>
        <div class="lista-historico" id="lista-historico"></div>
      </div>
    </div>

    <script>
      // ======= PWA INSTALLATION =======
      let deferredPrompt;
      const installButton = document.getElementById("installButton");
      const loading = document.getElementById("loading");

      // Mostrar botão de instalação quando possível
      window.addEventListener("beforeinstallprompt", (e) => {
        e.preventDefault();
        deferredPrompt = e;
        installButton.style.display = "block";

        installButton.addEventListener("click", async () => {
          loading.style.display = "flex";
          installButton.style.display = "none";

          deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice;

          loading.style.display = "none";
          deferredPrompt = null;
        });
      });

      // Esconder botão se já estiver instalado
      window.addEventListener("appinstalled", () => {
        installButton.style.display = "none";
        deferredPrompt = null;
        alert("App instalado com sucesso! 🎉");
      });

      // Verificar se já está instalado
      if (window.matchMedia("(display-mode: standalone)").matches) {
        installButton.style.display = "none";
      }

      // ======= AJUSTE DE DATA =======
      function dataAtualBrasil() {
        const agora = new Date();
        const offsetMs = agora.getTimezoneOffset() * 60000;
        const brasil = new Date(
          agora.getTime() - offsetMs - 3 * 60 * 60 * 1000
        );
        return brasil.toISOString().slice(0, 10);
      }
      const hoje = dataAtualBrasil();

      // ======= SISTEMA EXISTENTE =======
      let frentista = localStorage.getItem("frentista");
      if (frentista) {
        if (
          !confirm(
            `O frentista atual é "${frentista}". Continuar com este nome?`
          )
        ) {
          frentista = prompt("Digite o novo nome do frentista:") || "Frentista";
          localStorage.setItem("frentista", frentista);
        }
      } else {
        frentista = prompt("Digite seu nome:") || "Frentista";
        localStorage.setItem("frentista", frentista);
      }

      const valores = {
        dinheiro: parseFloat(localStorage.getItem("dinheiro")) || 0,
        cartao: parseFloat(localStorage.getItem("cartao")) || 0,
        vale: parseFloat(localStorage.getItem("vale")) || 0,
        pix: parseFloat(localStorage.getItem("pix")) || 0,
      };

      let historico = JSON.parse(localStorage.getItem("historico")) || [];

      const fmtBR = (v) =>
        new Intl.NumberFormat("pt-BR", {
          style: "currency",
          currency: "BRL",
        }).format(v);

      function atualizarHistorico() {
        const lista = document.getElementById("lista-historico");

        if (historico.length === 0) {
          lista.innerHTML =
            '<div class="sem-historico">Nenhum valor adicionado ainda</div>';
          return;
        }

        // Mostrar TODOS os itens (sem limite)
        const historicoRecente = [...historico].reverse();

        lista.innerHTML = historicoRecente
          .map((item, index) => {
            const classeOperacao =
              item.operacao === "subtracao" ? "subtracao" : "";
            return `
          <div class="item-historico ${classeOperacao}">
            <div class="info-historico">
              <div class="detalhes-historico">
                <span class="tipo-historico">${item.tipo}</span>
                <span class="valor-historico">${
                  item.operacao === "subtracao" ? "-" : "+"
                } ${fmtBR(item.valor)}</span>
                <span class="hora-historico">${item.hora}</span>
              </div>
            </div>
            <button class="btn-remover" onclick="removerDoHistorico(${
              historico.length - 1 - index
            })">
              Remover
            </button>
          </div>
        `;
          })
          .join("");
      }

      function adicionarAohistorico(tipo, valor, operacao) {
        const agora = new Date();
        const hora = agora.toLocaleTimeString("pt-BR", {
          hour: "2-digit",
          minute: "2-digit",
        });

        let tipoFormatado = tipo.charAt(0).toUpperCase() + tipo.slice(1);
        if (tipoFormatado === "Cartao") {
          tipoFormatado = "Cartão";
        }

        historico.push({
          tipo: tipoFormatado,
          valor: valor,
          operacao: operacao,
          hora: hora,
          timestamp: agora.getTime(),
        });

        // Sem limite de itens no histórico
        localStorage.setItem("historico", JSON.stringify(historico));
        atualizarHistorico();
      }

      function removerDoHistorico(index) {
        if (index < 0 || index >= historico.length) return;

        const item = historico[index];

        if (item.operacao === "adicao") {
          let tipoCorrigido = item.tipo.toLowerCase();
          if (tipoCorrigido === "cartão") {
            tipoCorrigido = "cartao";
          }
          valores[tipoCorrigido] = Math.max(
            0,
            valores[tipoCorrigido] - item.valor
          );
        } else if (item.operacao === "subtracao") {
          let tipoCorrigido = item.tipo.toLowerCase();
          if (tipoCorrigido === "cartão") {
            tipoCorrigido = "cartao";
          }
          valores[tipoCorrigido] += item.valor;
        }

        historico.splice(index, 1);
        localStorage.setItem("historico", JSON.stringify(historico));

        atualizarResumo();
        atualizarHistorico();
      }

      function atualizarResumo() {
        const total =
          valores.dinheiro + valores.cartao + valores.vale + valores.pix;
        document.getElementById("resumo").innerHTML = `
  <table>
    <tr><td colspan="2" style="text-align: center;" class="cabecalho-total">Resultado Parcial - ${hoje
      .split("-")
      .reverse()
      .join("/")}</td></tr>
    <tr><td>Frentista:</td><td>${frentista}</td></tr>
    <tr><td>Dinheiro:</td><td>${fmtBR(valores.dinheiro)}</td></tr>
    <tr><td>Cartão:</td><td>${fmtBR(valores.cartao)}</td></tr>
    <tr><td>Vale:</td><td>${fmtBR(valores.vale)}</td></tr>
    <tr><td>Pix:</td><td>${fmtBR(valores.pix)}</td></tr>
    <tr><td>Total:</td><td style="color:#2e7d32; font-size:15px;">${fmtBR(
      total
    )}</td></tr>
  </table>`;
        for (let k in valores) localStorage.setItem(k, valores[k]);
      }

      function adicionarValor(tipo) {
        const val = parseFloat(document.getElementById(tipo).value) || 0;
        if (val > 0) {
          valores[tipo] += val;
          adicionarAohistorico(tipo, val, "adicao");
        }
        document.getElementById(tipo).value = "";
        atualizarResumo();
      }

      document.getElementById("baixarPDF").addEventListener("click", () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: "pt", format: "a4" });
        const total =
          valores.dinheiro + valores.cartao + valores.vale + valores.pix;
        const dataFormatada = hoje.split("-").reverse().join("/");

        const linhas = [
          [
            {
              content: `Fechamento de Caixa - ${dataFormatada}`,
              colSpan: 2,
              styles: {
                halign: "center",
                fillColor: [11, 99, 212],
                textColor: [255, 255, 255],
                fontStyle: "bold",
                fontSize: 14,
              },
            },
          ],
          ["Frentista", frentista],
          ["Dinheiro", fmtBR(valores.dinheiro)],
          ["Cartão", fmtBR(valores.cartao)],
          ["Vale", fmtBR(valores.vale)],
          ["Pix", fmtBR(valores.pix)],
          [
            {
              content: "Total",
              styles: {
                fontStyle: "bold",
                fillColor: [240, 240, 240],
              },
            },
            {
              content: fmtBR(total),
              styles: {
                fontStyle: "bold",
                fillColor: [240, 240, 240],
                textColor: [46, 125, 50],
              },
            },
          ],
        ];

        doc.autoTable({
          startY: 60,
          body: linhas,
          theme: "grid",
          styles: {
            halign: "center",
            fontSize: 12,
            cellPadding: 10,
            fillColor: [255, 255, 255],
            textColor: 0,
            lineColor: [200, 200, 200],
            lineWidth: 0.5,
          },
          columnStyles: {
            0: {
              cellWidth: 180,
              fontStyle: "bold",
              halign: "left",
              fillColor: [250, 250, 250],
            },
            1: {
              cellWidth: 180,
              halign: "right",
              fillColor: [255, 255, 255],
            },
          },
          margin: {
            left: (doc.internal.pageSize.getWidth() - 360) / 2,
            right: (doc.internal.pageSize.getWidth() - 360) / 2,
          },
          tableLineWidth: 0.5,
          tableLineColor: [200, 200, 200],
        });

        doc.setFontSize(20);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(11, 99, 212);
        doc.text(
          "Relatório de Fechamento",
          doc.internal.pageSize.getWidth() / 2,
          40,
          {
            align: "center",
          }
        );

        doc.save(`fechamento_${dataFormatada.replace(/\//g, "-")}.pdf`);
      });

      document.getElementById("fecharTurno").addEventListener("click", () => {
        if (
          confirm(
            "⚠️ Tem certeza que deseja fechar o turno e zerar todos os valores?"
          )
        ) {
          for (let k in valores) valores[k] = 0;
          historico = [];
          localStorage.removeItem("historico");
          atualizarResumo();
          atualizarHistorico();
          alert("Turno fechado e valores zerados.");
        }
      });

      // Inicializar
      atualizarResumo();
      atualizarHistorico();

      // Prevenir comportamento padrão de refresh em PWA
      window.addEventListener("beforeunload", (e) => {
        if (historico.length > 0) {
          e.preventDefault();
          e.returnValue =
            "Você tem dados não salvos. Tem certeza que deseja sair?";
        }
      });
    </script>
  </body>
</html>
